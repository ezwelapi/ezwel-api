<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ezwel.htl.interfaces.server.repository.EzcGuestRoomMapper">
<!--
 * History : SQL Mapper Generated By iCodeManager Made by API Team KSW
 *
 * 버전          성명                   일자              		변경내용
 * =======       ================       ===================		=================
 * 0.0.1         iCodeManager     2019-01-29 11:00:24 	신규작성 
 * 
 * @since 2019-01-29 11:00:24
 * @version 0.0.1
 * @author ksw
 * @see "DBIO Mapper"
 * -->
<select id="selectListGuestRoom" parameterType="ezcFaclHist" resultType="ezcGuestRoom">
SELECT * FROM (
	SELECT ROWNUM AS ROW__NUM, RECORDS.* FROM (
	/* #### SQL Body [[ ################# */
		SELECT
			 INLINE.FACL_CD AS faclCd /* EZC 직영숙박 객실조회, CHAR(0) */
			,INLINE.PARTNER_CD AS partnerCd /* 제휴사 코드, CHAR(0) */
			,INLINE.ROOM_NO AS roomNo /* 시설 코드, CHAR(0) */
			,INLINE.ROOM_NAME AS roomName /* 객실상품코드, CHAR(0) */
			,INLINE.PRICE_FOR_LIST AS priceForList /* 정상가, NUMBER(0,22) */
			,INLINE.PRICE_FOR_SALE AS priceForSale /* 판매가, NUMBER(0,22) */
			,INLINE.ADT_CNT_MIN AS adtCntMin /* 기준인원, NUMBER(0,22) */
			,INLINE.ADT_CNT_MAX AS adtCntMax /* 최대인원, NUMBER(0,22) */
			,INLINE.ROOM_INFO AS roomInfo /* 객실정보, CHAR(0) */
			,INLINE.ROOM_AVAIL_COUNT AS roomAvailCount /* 잔여객실수량, NUMBER(0,22) */
			,INLINE.RSV_TYPE_CODE AS rsvTypeCode /* 확정예약여부코드, CHAR(0) */
			,INLINE.BREAKFAST AS breakfast /* 조식포함여부, CHAR(0) */
			,INLINE.SPC_TYPE AS spcType /* 특가상품여부, CHAR(0) */
			,INLINE.SPC_TYPE_TIME AS spcTypeTime /* 특가상품종료일시, CHAR(0) */
		FROM (
			SELECT /*+ NO_MERGE */
				FACL_CD,
				PARTNER_CD,
				ROOM_NO,
				ROOM_NAME,
				SUM (PRICE_FOR_LIST) * #{roomCnt, jdbcType=NUMERIC} AS PRICE_FOR_LIST,
				SUM (PRICE_FOR_SALE) * #{roomCnt, jdbcType=NUMERIC} AS PRICE_FOR_SALE,
				ADT_CNT_MIN,
				ADT_CNT_MAX,
				ROOM_INFO,
				MIN (ROOM_AVAIL_COUNT) AS ROOM_AVAIL_COUNT,
				RSV_TYPE_CODE,
				BREAKFAST,
				SPC_TYPE,
				SPC_TYPE_TIME
			FROM (
				SELECT 
					F.FACL_CD,
					F.PARTNER_CD,
					C.ROOM_GOODS_CD AS ROOM_NO,
					C.ROOM_GOODS_NM AS ROOM_NAME,
					C.NORMAL_AMT AS PRICE_FOR_LIST,
					D.SALE_AMT_PC AS PRICE_FOR_SALE,
					A.STD_USER_CNT AS ADT_CNT_MIN,
					A.MAX_USER_CNT AS ADT_CNT_MAX,
					A.ROOM_INFO || A.ROOM_FACL_DESC || C.GOODS_DESC AS ROOM_INFO,
					B.RESERVPOSS_ROOM_CNT AS ROOM_AVAIL_COUNT,
					CASE
						WHEN B.RESERVPOSS_ROOM_CNT > 0 THEN '2' /* 확정 */
						WHEN B.RESERVPOSS_ROOM_CNT = 0 THEN '1' /* 일반 */
						ELSE '0' /* 마감(-1) */
					END AS RSV_TYPE_CODE,
					C.BREAKFAST_INCLUDE_YN AS BREAKFAST,
					CASE
						WHEN C.DAY_PRICE_YN = 'Y' THEN '2' /* 당일특가 */
						WHEN C.SPEC_YN = 'Y' THEN '1' /* 특가 */
						ELSE '0' /* 일반 */
					END AS SPC_TYPE,
					C.DAY_PRICE_END_TM SPC_TYPE_TIME
				FROM EZC_FACL F,
					 EZC_ROOM A,
					 EZC_ROOM_BLOCK B,
					 EZC_ROOM_GOODS C,
					 EZC_ROOM_BLOCK_GOODS D
				WHERE 1=1
					AND F.FACL_CD = A.FACL_CD
					AND A.ROOM_CD = B.ROOM_CD
					AND A.ROOM_CD = C.ROOM_CD
					AND C.ROOM_GOODS_CD = D.ROOM_GOODS_CD
					AND B.BLOCK_DD = D.SALE_DD    
					AND B.BLOCK_DD BETWEEN #{checkInDate, jdbcType=VARCHAR} AND TO_CHAR ( TO_DATE ( #{checkOutDate, jdbcType=VARCHAR}, 'yyyyMMdd' ) - 1, 'yyyyMMdd' )
					AND D.SALE_DD BETWEEN #{checkInDate, jdbcType=VARCHAR} AND TO_CHAR ( TO_DATE ( #{checkOutDate, jdbcType=VARCHAR}, 'yyyyMMdd' ) - 1, 'yyyyMMdd' )
					AND D.SALE_AMT_PC IS NOT NULL
					AND A.FACL_CD = #{faclCd, jdbcType=VARCHAR}
				)
			GROUP BY 
				FACL_CD,
				PARTNER_CD,
				ROOM_NO,
				ROOM_NAME,
				ADT_CNT_MIN,
				ADT_CNT_MAX,
				ROOM_INFO,
				RSV_TYPE_CODE,
				BREAKFAST,
				SPC_TYPE,
				SPC_TYPE_TIME
			) INLINE /* EZC 직영숙박 객실조회 */
		ORDER BY
			INLINE.PRICE_FOR_SALE
		/* #### SQL Body ]] ################# */
	) RECORDS
	WHERE ROWNUM &lt;= ((#{pageNum, jdbcType=NUMERIC}*#{pageCount, jdbcType=NUMERIC})+1) 
)
WHERE ROW__NUM &gt; (#{pageNum, jdbcType=NUMERIC}-1)*#{pageCount, jdbcType=NUMERIC}
</select>

</mapper>
