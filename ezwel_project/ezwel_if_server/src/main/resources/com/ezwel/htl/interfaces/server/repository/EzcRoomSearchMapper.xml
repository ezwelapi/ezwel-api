<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ezwel.htl.interfaces.server.repository.EzcRoomSearchMapper">
<!--
 * History : SQL Mapper Generated By iCodeManager Made by API Team KSW
 *
 * 버전          성명                   일자              		변경내용
 * =======       ================       ===================		=================
 * 0.0.1         iCodeManager     		2019-01-29 11:00:24 	신규작성 
 * 
 * @since 2019-01-29 11:00:24
 * @version 0.0.1
 * @author ksw
 * @see "DBIO Mapper"
 * -->
<select id="selectListFaclSearch" parameterType="ezcRoomSearch" resultType="ezcRoomSearch">
SELECT * FROM (
	SELECT ROWNUM AS ROW__NUM, RECORDS.* FROM (
		/* #### SQL Body [[ ################# */
		WITH EZC_FACL_ROOM AS /* 시설 최저가 검색 */ (
	        SELECT 
	            *
	        FROM (
				SELECT /*+ NO_MERGE */
	                FACL_CD,        /* 시설 코드 */
	                GRP_FACL_CD,    /* 시설 그룹 코드 */
	                PARTNER_CD,     /* 제휴사 코드 */
	                ROOM_NO,        /* 객실 번호 */
	                ROOM_NAME,      /* 객실 명 */
	                SUM (PRICE_FOR_LIST) * 1 AS PRICE_FOR_LIST, /* 정상가, NUMBER(0,22) */
	                SUM (PRICE_FOR_SALE) * 1 AS PRICE_FOR_SALE, /* 판매가, NUMBER(0,22) */
	                ADT_CNT_MIN,    /* 기준인원, NUMBER(0,22) */
	                ADT_CNT_MAX,    /* 최대인원, NUMBER(0,22) */
	                MIN (ROOM_AVAIL_COUNT) AS ROOM_AVAIL_COUNT, /* 잔여객실수량, NUMBER(0,22) */
	                RSV_TYPE_CODE,  /* 확정예약여부코드 */
	                BREAKFAST,      /* 조식포함여부 */
	                SPC_TYPE,       /* 특가상품여부 */
	                SPC_TYPE_TIME   /* 특가상품종료일시 */
	            FROM (
	                SELECT 
	                    F.FACL_CD,
	                    M.GRP_FACL_CD,
	                    F.PARTNER_CD,
	                    C.ROOM_GOODS_CD AS ROOM_NO,
	                    C.ROOM_GOODS_NM AS ROOM_NAME,
	                    C.NORMAL_AMT AS PRICE_FOR_LIST,
	                    D.SALE_AMT_PC AS PRICE_FOR_SALE,
	                    A.STD_USER_CNT AS ADT_CNT_MIN,
	                    A.MAX_USER_CNT AS ADT_CNT_MAX,
	                    B.RESERVPOSS_ROOM_CNT AS ROOM_AVAIL_COUNT,
	                    CASE
	                        WHEN B.RESERVPOSS_ROOM_CNT > 0 THEN '2' /* 확정 */
	                        WHEN B.RESERVPOSS_ROOM_CNT = 0 THEN '1' /* 일반 */
	                        ELSE '0' /* 마감(-1) */
	                    END AS RSV_TYPE_CODE,
	                    C.BREAKFAST_INCLUDE_YN AS BREAKFAST,
	                    CASE
	                        WHEN C.DAY_PRICE_YN = 'Y' THEN '2' /* 당일특가 */
	                        WHEN C.SPEC_YN = 'Y' THEN '1' /* 특가 */
	                        ELSE '0' /* 일반 */
	                    END AS SPC_TYPE,
	                    C.DAY_PRICE_END_TM SPC_TYPE_TIME,
	                    F.CITY_CD
	                FROM EZC_FACL F,
	                     EZC_MAPPING_FACL M,
	                     EZC_ROOM A,
	                     EZC_ROOM_BLOCK B,
	                     EZC_ROOM_GOODS C,
	                     EZC_ROOM_BLOCK_GOODS D
	                WHERE 1=1
	                    AND F.FACL_CD = A.FACL_CD
	                    AND F.FACL_CD = M.FACL_CD
	                    AND A.ROOM_CD = B.ROOM_CD
	                    AND A.ROOM_CD = C.ROOM_CD
	                    AND C.ROOM_GOODS_CD = D.ROOM_GOODS_CD
	                    AND B.BLOCK_DD = D.SALE_DD    
	                    AND D.SALE_AMT_PC IS NOT NULL
	                    AND F.FACL_DIV = 'G0010002' /* 시설구분 : 직영/숙박 */
	                    AND B.BLOCK_DD BETWEEN #{checkInDate, jdbcType=VARCHAR} AND TO_CHAR ( TO_DATE ( #{checkOutDate, jdbcType=VARCHAR}, 'yyyyMMdd' ) - 1, 'yyyyMMdd' ) /* 체크인/체크아웃 일자(파라메터)  */
	                    AND D.SALE_DD BETWEEN #{checkInDate, jdbcType=VARCHAR} AND TO_CHAR ( TO_DATE ( #{checkOutDate, jdbcType=VARCHAR}, 'yyyyMMdd' ) - 1, 'yyyyMMdd' )  /* 체크인/체크아웃 일자(파라메터)  */
	                    AND F.CITY_CD = #{sidoCode, jdbcType=VARCHAR}
						<if test="gunguCode != null and gunguCode != ''">
						AND F.AREA_CD = #{gunguCode, jdbcType=VARCHAR}	/* 구군코드 */
						</if>	                    
	                )
	            GROUP BY 
	                FACL_CD,
	                GRP_FACL_CD,
	                PARTNER_CD, 
	                ROOM_NO,
	                ROOM_NAME,
	                ADT_CNT_MIN,
	                ADT_CNT_MAX,
	                RSV_TYPE_CODE,
	                BREAKFAST,
	                SPC_TYPE,
	                SPC_TYPE_TIME
	        )
	        WHERE
	            ROOM_AVAIL_COUNT >= 1 /* 잔여객실수량이 존재하는것 (객실수 파라메터) */
	    )
	    SELECT 
	         GRP_FACL_CD	grpFaclCd
	        ,FACL_CD		faclCd
	        ,ROOM_NET_PRICE roomMinPrice 	/* 객실 최저가 */
	        ,ROOM_NET_PRICE roomNetPrice	/* 객실 정상가 */
	        ,SP_ROOM_NET_PRICE spRoomMinPrice	/* 특가 최저가 */
	        ,SP_ROOM_NET_PRICE spRoomNetPrice	/* 특가 정상가 */
	    FROM (
	        SELECT /*+ NO_MERGE */
	             A.GRP_FACL_CD
	            ,A.FACL_CD
	            /* ,A.PARTNER_CD */
	            /* ,A.ROOM_NO */
	            ,NVL(A.PRICE_FOR_SALE, 0) AS ROOM_NET_PRICE /* 객실 정상가 */
	            ,NVL(B.PRICE_FOR_SALE, 0) AS SP_ROOM_NET_PRICE /* 특가 정상가 */            
	        FROM 
	             EZC_FACL_ROOM A
	            ,(
	                SELECT /*+ NO_MERGE */
	                     AMT.GRP_FACL_CD
	                    ,AMT.FACL_CD
	                    ,AMT.PARTNER_CD
	                    ,MAX(AMT.ROOM_NO) AS ROOM_NO
	                    ,MIN(NVL(AMT.PRICE_FOR_SALE, 0)) AS PRICE_FOR_SALE /* 최저 객실 정상가 */  
	                FROM 
	                     EZC_FACL_ROOM AMT    
	                GROUP BY 
	                     AMT.GRP_FACL_CD
	                    ,AMT.FACL_CD
	                    ,AMT.PARTNER_CD
	            ) AMT
	            ,EZC_FACL_ROOM B
	        WHERE 1=1
	            AND A.GRP_FACL_CD = AMT.GRP_FACL_CD
	            AND A.FACL_CD = AMT.FACL_CD
	            AND A.PARTNER_CD = AMT.PARTNER_CD
	            AND A.ROOM_NO = AMT.ROOM_NO
	            AND A.PRICE_FOR_SALE = AMT.PRICE_FOR_SALE
	            AND A.FACL_CD = B.FACL_CD(+)
	            AND A.GRP_FACL_CD = B.GRP_FACL_CD(+)
	            AND A.PARTNER_CD = B.PARTNER_CD(+)
	            AND A.ROOM_NO = B.ROOM_NO(+)
	            AND B.SPC_TYPE(+) = '1'  /* 특가 */
	    )
		/* #### SQL Body ]] ################# */
	) RECORDS
	WHERE ROWNUM &lt;= ((#{pageNum, jdbcType=NUMERIC}*#{pageCount, jdbcType=NUMERIC})+1) 
)
WHERE ROW__NUM &gt; (#{pageNum, jdbcType=NUMERIC}-1)*#{pageCount, jdbcType=NUMERIC}
</select>



<select id="selectListSddSearch" parameterType="ezcRoomSearch" resultType="ezcRoomSearch">
SELECT * FROM (
	SELECT ROWNUM AS ROW__NUM, RECORDS.* FROM (
		/* #### SQL Body [[ ################# */
	    WITH EZC_FACL_ROOM AS /* 당일 특가 검색 */ (
	        SELECT 
	            *
	        FROM (
	               SELECT /*+ NO_MERGE */
	                FACL_CD,        /* 시설 코드 */
	                GRP_FACL_CD,    /* 시설 그룹 코드 */
	                PARTNER_CD,     /* 제휴사 코드 */
	                ROOM_NO,        /* 객실 번호 */
	                ROOM_NAME,      /* 객실 명 */
	                SUM (PRICE_FOR_LIST) * 1 AS PRICE_FOR_LIST, /* 정상가, NUMBER(0,22) 객실수(파라메터) */
	                SUM (PRICE_FOR_SALE) * 1 AS PRICE_FOR_SALE, /* 판매가, NUMBER(0,22) 객실수(파라메터) */
	                ADT_CNT_MIN,    /* 기준인원, NUMBER(0,22) */
	                ADT_CNT_MAX,    /* 최대인원, NUMBER(0,22) */
	                MIN (ROOM_AVAIL_COUNT) AS ROOM_AVAIL_COUNT, /* 잔여객실수량, NUMBER(0,22) */
	                RSV_TYPE_CODE,  /* 확정예약여부코드 */
	                BREAKFAST,      /* 조식포함여부 */
	                SPC_TYPE,       /* 특가상품여부 */
	                SPC_TYPE_TIME   /* 특가상품종료일시 */
	            FROM (
	                SELECT 
	                    F.FACL_CD,
	                    M.GRP_FACL_CD,
	                    F.PARTNER_CD,
	                    C.ROOM_GOODS_CD AS ROOM_NO,
	                    C.ROOM_GOODS_NM AS ROOM_NAME,
	                    C.NORMAL_AMT AS PRICE_FOR_LIST,
	                    D.SALE_AMT_PC AS PRICE_FOR_SALE,
	                    A.STD_USER_CNT AS ADT_CNT_MIN,
	                    A.MAX_USER_CNT AS ADT_CNT_MAX,
	                    B.RESERVPOSS_ROOM_CNT AS ROOM_AVAIL_COUNT,
	                    CASE
	                        WHEN B.RESERVPOSS_ROOM_CNT > 0 THEN '2' /* 확정 */
	                        WHEN B.RESERVPOSS_ROOM_CNT = 0 THEN '1' /* 일반 */
	                        ELSE '0' /* 마감(-1) */
	                    END AS RSV_TYPE_CODE,
	                    C.BREAKFAST_INCLUDE_YN AS BREAKFAST,
	                    CASE
	                        WHEN C.DAY_PRICE_YN = 'Y' THEN '2' /* 당일특가 */
	                        WHEN C.SPEC_YN = 'Y' THEN '1' /* 특가 */
	                        ELSE '0' /* 일반 */
	                    END AS SPC_TYPE,
	                    C.DAY_PRICE_END_TM SPC_TYPE_TIME
	                FROM EZC_FACL F,
	                     EZC_MAPPING_FACL M,
	                     EZC_ROOM A,
	                     EZC_ROOM_BLOCK B,
	                     EZC_ROOM_GOODS C,
	                     EZC_ROOM_BLOCK_GOODS D
	                WHERE 1=1
	                    AND F.FACL_CD = A.FACL_CD
	                    AND F.FACL_CD = M.FACL_CD
	                    AND A.ROOM_CD = B.ROOM_CD
	                    AND A.ROOM_CD = C.ROOM_CD
	                    AND C.ROOM_GOODS_CD = D.ROOM_GOODS_CD
	                    AND B.BLOCK_DD = D.SALE_DD    
	                    AND B.BLOCK_DD BETWEEN #{checkInDate, jdbcType=VARCHAR} AND TO_CHAR ( TO_DATE ( #{checkOutDate, jdbcType=VARCHAR}, 'yyyyMMdd' ) - 1, 'yyyyMMdd' ) /* 체크인/체크아웃 일자(파라메터)  */
	                    AND D.SALE_DD BETWEEN #{checkInDate, jdbcType=VARCHAR} AND TO_CHAR ( TO_DATE ( #{checkOutDate, jdbcType=VARCHAR}, 'yyyyMMdd' ) - 1, 'yyyyMMdd' )  /* 체크인/체크아웃 일자(파라메터)  */
	                    AND D.SALE_AMT_PC IS NOT NULL
	                    AND F.FACL_DIV = 'G0010002' /* 시설구분 : 직영/숙박 */
	                )
	            GROUP BY 
	                FACL_CD,
	                GRP_FACL_CD,
	                PARTNER_CD,
	                ROOM_NO,
	                ROOM_NAME,
	                ADT_CNT_MIN,
	                ADT_CNT_MAX,
	                RSV_TYPE_CODE,
	                BREAKFAST,
	                SPC_TYPE,
	                SPC_TYPE_TIME
	        )
	        WHERE
	            ROOM_AVAIL_COUNT >= 1 /* 잔여객실수량이 존재하는것 (객실수 파라메터) */
	    )
	    SELECT 
	         GRP_FACL_CD
	        ,FACL_CD
	        ,DAY_PRICE_NET_PRICE DAY_PRICE_MIN_PRICE /* 당일특가 최저가 */
	        ,DAY_PRICE_NET_PRICE /* 당일특가 정상가 */
	        ,DAY_PRICE_DD /* 당일특가 일자 */
	        ,SPC_TYPE_TIME /* 판매 종료 시분 */
	    FROM (
	        SELECT /*+ NO_MERGE */
	             A.GRP_FACL_CD
	            ,A.FACL_CD
	            /* ,A.PARTNER_CD */
	            /* ,A.ROOM_NO */
	            ,NVL(A.PRICE_FOR_SALE, 0) AS DAY_PRICE_NET_PRICE /* 당일특가 정상가 */
	            ,#{checkInDate, jdbcType=VARCHAR} DAY_PRICE_DD
	            ,A.SPC_TYPE_TIME
	        FROM 
	             EZC_FACL_ROOM A
	        WHERE 1=1
	            AND SPC_TYPE = '2'  /* 당일특가 */
	    )
		/* #### SQL Body ]] ################# */
	) RECORDS
	WHERE ROWNUM &lt;= ((#{pageNum, jdbcType=NUMERIC}*#{pageCount, jdbcType=NUMERIC})+1) 
)
WHERE ROW__NUM &gt; (#{pageNum, jdbcType=NUMERIC}-1)*#{pageCount, jdbcType=NUMERIC}
</select>

</mapper>
